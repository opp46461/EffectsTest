using UnityEngine;
using UnityEditor;
using System.IO;
using System.Collections;

namespace LiquidVolumeFX
{
    [CustomEditor(typeof(LiquidVolume)), CanEditMultipleObjects]
    public class LiquidVolumeEditor : Editor
    {

        static GUIStyle titleLabelStyle, sectionHeaderStyle;
        static Color titleColor;
        static bool[] expandSection = new bool[6];
        const string SECTION_PREFS = "LiquidVolumeExpandSection";
        static string[] sectionNames = new string[] {
                                                "Liquid Settings",
                                                "Foam Settings",
                                                "Smoke Settings",
                                                "Flask Settings",
                                                "Physics",
                                                "Advanced"
                                };
        const int LIQUID_SETTINGS = 0;
        const int FOAM_SETTINGS = 1;
        const int SMOKE_SETTINGS = 2;
        const int FLASK_SETTINGS = 3;
        const int PHYSICS_SETTINGS = 4;
        const int ADVANCED_SETTINGS = 5;
        SerializedProperty topology, detail, depthAware, depthAwareCustomPass, ignoreGravity, reactToForces, doubleSidedBias, rotationLevelBias;
        SerializedProperty level, liquidColor1, liquidColor2, liquidScale1, liquidScale2, alpha, emissionColor, emissionBrightness;
        SerializedProperty ditherShadows, murkiness, turbulence1, turbulence2, frecuency, speed;
        SerializedProperty sparklingIntensity, sparklingAmount, deepObscurance;
        SerializedProperty foamColor, foamScale, foamThickness, foamDensity, foamWeight, foamVisibleFromBottom, foamTurbulence;
        SerializedProperty smokeEnabled, smokeColor, smokeScale, smokeBaseObscurance, smokeSpeed;
        SerializedProperty flaskTint, flaskThickness, flaskGlossinessExternal, flaskGlossinessInternal, refractionBlur, blurIntensity;
        SerializedProperty scatteringEnabled, scatteringPower, scatteringAmount;
        SerializedProperty liquidRaySteps, foamRaySteps, smokeRaySteps, extentsScale, upperLimit, noiseVariation, allowViewFromInside;
        SerializedProperty bumpMap, bumpDistortionScale, bumpDistortionOffset, distortionMap, texture, textureAlpha, textureScale, textureOffset;
        SerializedProperty distortionAmount, renderQueue;
        SerializedProperty reflectionTexture;
        SerializedProperty physicsMass, physicsAngularDamp;
        SerializedProperty debugSpillPoint;
        SerializedProperty fixedSpillPoint;
        SerializedProperty limitLevel;
        MeshRenderer mr;

        void OnEnable()
        {
            titleColor = EditorGUIUtility.isProSkin ? new Color(0.52f, 0.66f, 0.9f) : new Color(0.12f, 0.16f, 0.4f);
            for (int k = 0; k < expandSection.Length; k++)
            {
                expandSection[k] = EditorPrefs.GetBool(SECTION_PREFS + k, false);
            }
            topology = serializedObject.FindProperty("_topology");
            detail = serializedObject.FindProperty("_detail");
            depthAware = serializedObject.FindProperty("_depthAware");
            depthAwareCustomPass = serializedObject.FindProperty("_depthAwareCustomPass");

            level = serializedObject.FindProperty("_level");
            liquidColor1 = serializedObject.FindProperty("_liquidColor1");
            liquidColor2 = serializedObject.FindProperty("_liquidColor2");
            liquidScale1 = serializedObject.FindProperty("_liquidScale1");
            liquidScale2 = serializedObject.FindProperty("_liquidScale2");
            alpha = serializedObject.FindProperty("_alpha");
            emissionColor = serializedObject.FindProperty("_emissionColor");
            emissionBrightness = serializedObject.FindProperty("_emissionBrightness");
            ditherShadows = serializedObject.FindProperty("_ditherShadows");
            murkiness = serializedObject.FindProperty("_murkiness");
            turbulence1 = serializedObject.FindProperty("_turbulence1");
            turbulence2 = serializedObject.FindProperty("_turbulence2");
            frecuency = serializedObject.FindProperty("_frecuency");
            speed = serializedObject.FindProperty("_speed");
            sparklingIntensity = serializedObject.FindProperty("_sparklingIntensity");
            sparklingAmount = serializedObject.FindProperty("_sparklingAmount");
            deepObscurance = serializedObject.FindProperty("_deepObscurance");
            scatteringEnabled = serializedObject.FindProperty("_scatteringEnabled");
            scatteringPower = serializedObject.FindProperty("_scatteringPower");
            scatteringAmount = serializedObject.FindProperty("_scatteringAmount");

            foamColor = serializedObject.FindProperty("_foamColor");
            foamScale = serializedObject.FindProperty("_foamScale");
            foamThickness = serializedObject.FindProperty("_foamThickness");
            foamDensity = serializedObject.FindProperty("_foamDensity");
            foamWeight = serializedObject.FindProperty("_foamWeight");
            foamTurbulence = serializedObject.FindProperty("_foamTurbulence");
            foamVisibleFromBottom = serializedObject.FindProperty("_foamVisibleFromBottom");

            smokeEnabled = serializedObject.FindProperty("_smokeEnabled");
            smokeColor = serializedObject.FindProperty("_smokeColor");
            smokeScale = serializedObject.FindProperty("_smokeScale");
            smokeBaseObscurance = serializedObject.FindProperty("_smokeBaseObscurance");
            smokeSpeed = serializedObject.FindProperty("_smokeSpeed");

            flaskTint = serializedObject.FindProperty("_flaskTint");
            flaskThickness = serializedObject.FindProperty("_flaskThickness");
            flaskGlossinessExternal = serializedObject.FindProperty("_flaskGlossinessExternal");
            flaskGlossinessInternal = serializedObject.FindProperty("_flaskGlossinessInternal");
            refractionBlur = serializedObject.FindProperty("_refractionBlur");
            blurIntensity = serializedObject.FindProperty("_blurIntensity");

            liquidRaySteps = serializedObject.FindProperty("_liquidRaySteps");
            foamRaySteps = serializedObject.FindProperty("_foamRaySteps");
            smokeRaySteps = serializedObject.FindProperty("_smokeRaySteps");
            extentsScale = serializedObject.FindProperty("_extentsScale");
            upperLimit = serializedObject.FindProperty("_upperLimit");
            noiseVariation = serializedObject.FindProperty("_noiseVariation");
            allowViewFromInside = serializedObject.FindProperty("_allowViewFromInside");
            renderQueue = serializedObject.FindProperty("_renderQueue");

            bumpMap = serializedObject.FindProperty("_bumpMap");
            bumpDistortionScale = serializedObject.FindProperty("_bumpDistortionScale");
            bumpDistortionOffset = serializedObject.FindProperty("_bumpDistortionOffset");
            distortionMap = serializedObject.FindProperty("_distortionMap");
            distortionAmount = serializedObject.FindProperty("_distortionAmount");
            texture = serializedObject.FindProperty("_texture");
            textureAlpha = serializedObject.FindProperty("_textureAlpha");
            textureScale = serializedObject.FindProperty("_textureScale");
            textureOffset = serializedObject.FindProperty("_textureOffset");

            reflectionTexture = serializedObject.FindProperty("_reflectionTexture");
            reactToForces = serializedObject.FindProperty("_reactToForces");
            ignoreGravity = serializedObject.FindProperty("_ignoreGravity");
            physicsMass = serializedObject.FindProperty("_physicsMass");
            physicsAngularDamp = serializedObject.FindProperty("_physicsAngularDamp");

            debugSpillPoint = serializedObject.FindProperty("_debugSpillPoint");
            fixedSpillPoint = serializedObject.FindProperty("_fixedSpillPoint");
            limitLevel = serializedObject.FindProperty("_limitLevel");
            doubleSidedBias = serializedObject.FindProperty("_doubleSidedBias");
            rotationLevelBias = serializedObject.FindProperty("_rotationLevelBias");
        }

        void OnDestroy()
        {
            // Save folding sections state
            for (int k = 0; k < expandSection.Length; k++)
            {
                EditorPrefs.SetBool(SECTION_PREFS + k, expandSection[k]);
            }
        }

        public override void OnInspectorGUI()
        {
#if UNITY_5_6_OR_NEWER
            serializedObject.UpdateIfRequiredOrScript();
#else
												serializedObject.UpdateIfDirtyOrScript ();
#endif

            if (sectionHeaderStyle == null)
            {
                sectionHeaderStyle = new GUIStyle(EditorStyles.foldout);
            }
            sectionHeaderStyle.normal.textColor = titleColor;
            sectionHeaderStyle.margin = new RectOffset(12, 0, 0, 0);
            sectionHeaderStyle.fontStyle = FontStyle.Bold;

            if (titleLabelStyle == null)
            {
                titleLabelStyle = new GUIStyle(EditorStyles.label);
            }
            titleLabelStyle.normal.textColor = titleColor;
            titleLabelStyle.fontStyle = FontStyle.Bold;


            EditorGUILayout.Separator();

            EditorGUILayout.BeginHorizontal();
            EditorGUILayout.LabelField("Í¨ÓÃÉèÖÃ", titleLabelStyle);
            if (GUILayout.Button("°ïÖú", GUILayout.Width(40)))
            {
                if (!EditorUtility.DisplayDialog("Liquid Volume", "To learn more about a property in this inspector move the mouse over the label for a quick description (tooltip).\n\nPlease check README file in the root of the asset for details and contact support.\n\nIf you like Liquid Volume, please rate it on the Asset Store. For feedback and suggestions visit our support forum on kronnect.com.", "Close", "Visit Support Forum"))
                {
                    Application.OpenURL("http://kronnect.com/taptapgo");
                }
            }
            EditorGUILayout.EndHorizontal();

            EditorGUILayout.PropertyField(topology, new GUIContent("ÍøÂç²¼¾ÖÀàÐÍ", "Ìå»ýÐÎ×´."));
            EditorGUILayout.PropertyField(detail, new GUIContent("Ï¸½Ú", "ÒºÌåÐ§¹ûµÄÏ¸½ÚÁ¿¡£¡°Simple¡±ÉèÖÃ²»Ê¹ÓÃ3DÎÆÀí£¬ÕâÊ¹µÃËüÓëÒÆ¶¯Éè±¸¼æÈÝ."));
            EditorGUILayout.PropertyField(depthAware, new GUIContent("Éî¶È", "ÔÚÒºÌåÌå»ýÄÚÆôÓÃz-testing¡£Èç¹ûÌå»ýÖÐº¬ÓÐÒºÌåÒÔÍâµÄÆäËûÎïÌå£¬ÔòÊ¹ÓÃ£¬·ñÔò²»ÒªÆôÓÃ¡£ÒºÌåÌå»ýÄÚµÄ2D¶ÔÏóÐèÒªÊ¹ÓÃÒ»¸ö²»Í¸Ã÷µÄÇÐ¸î×ÅÉ«Æ÷Ð´Èëz-buffer(±ê×¼×ÅÉ«Æ÷ÇÐ¸îÄ£Ê½ÊÇÒ»¸öºÜºÃµÄÑ¡Ôñ)."));
            if (target != null)
            {
                LiquidVolume lv = (LiquidVolume)target;
                if (lv.transform.parent == null)
                    GUI.enabled = false;
            }
            EditorGUILayout.PropertyField(depthAwareCustomPass, new GUIContent("¸¸ÎïÌå", "Ê¹ÓÃ¸¸¼¸ºÎÍ¼ÐÎ×÷Îªµ±Ç°ÒºÌåµÄ±ß½ç¡£½öµ±ÒºÌåÌå»ýÎ»ÓÚÁíÒ»¸öÎïÌåÄÚ²¿Ê±£¬²ÅÔÚ²»¹æÔòÍØÆË½á¹¹ÏÂÊ¹ÓÃ£¬²¢·ÀÖ¹Í¸¹ýÈÝÆ÷¿´µ½±³¾°ÖÐµÄÆäËûÒºÌå¡£Èç¹û¿´²»µ½ÈÎºÎÎ±Ó°£¬Çë²»ÒªÆôÓÃ´ËÑ¡Ïî£¬ÒòÎªËü»áÎªÒºÌåÈÝÆ÷Ìí¼Ó¶îÍâµÄäÖÈ¾Í¨µÀ."));
            GUI.enabled = true;

            EditorGUILayout.PropertyField(alpha, new GUIContent("×ÜÌåÍ¸Ã÷¶È", "ÒºÌå¡¢ÑÌÎíºÍÅÝÄ­µÄÈ«ÇòÍ¸Ã÷¶È¡£Äú»¹¿ÉÒÔ½«ÆäÓëÒºÌå£¬ÑÌÎíºÍÅÝÄ­ÑÕÉ«µÄ°¢¶û·¨Ïà½áºÏ."));

            int detailed = detail.intValue;

            if (detailed != (int)DETAIL.Smoke)
            {
                EditorGUILayout.Separator();
                expandSection[LIQUID_SETTINGS] = EditorGUILayout.Foldout(expandSection[LIQUID_SETTINGS], "ÒºÌåµÄÉèÖÃ", sectionHeaderStyle);

                if (expandSection[LIQUID_SETTINGS])
                {
                    EditorGUILayout.PropertyField(level, new GUIContent("Ë®Æ½", "Ìå»ýµÄÌî³äË®Æ½."));

                    EditorGUILayout.PropertyField(liquidColor1, new GUIContent("ÒºÌåÑÕÉ«1"));
                    if (detailed >= 10)
                    {
                        EditorGUILayout.PropertyField(liquidScale1, new GUIContent("±ÈÀý1", "Ó¦ÓÃÓÚÒºÌåµÚÒ»ÎÆÀíµÄ¿Ì¶È."));
                        EditorGUILayout.PropertyField(liquidColor2, new GUIContent("ÒºÌåÑÕÉ«2"));
                        EditorGUILayout.PropertyField(liquidScale2, new GUIContent("±ÈÀý2", "Scale applied to the 2nd texture of the liquid."));
                        EditorGUILayout.PropertyField(murkiness, new GUIContent("±íÃæëüëÊ", "ÒºÌåµÄ´¿¶È¡£0 = ¾§Ó¨ÌÞÍ¸£¬1 = ³äÂúÄà½¬/ÎÛ¹¸."));
                    }

                    EditorGUILayout.PropertyField(emissionColor, new GUIContent("×Ô·¢¹âÑÕÉ«"));
                    EditorGUILayout.PropertyField(emissionBrightness, new GUIContent("×Ô·¢¹âÁÁ¶È"));
                    EditorGUILayout.PropertyField(ditherShadows, new GUIContent("¶¶¶¯ÒõÓ°", "ÆôÓÃ´ËÑ¡Ïî¿É¶ÔÒºÌåÒõÓ°Ó¦ÓÃ¶¶¶¯£¬Ä£Äâ²¿·ÖÍ¸Ã÷µÄÒõÓ°¡£ÎªÁË»ñµÃ×î¼ÑÐ§¹û£¬¿ÉÔÚÖÊÁ¿ÉèÖÃÖÐÆôÓÃÈáºÍÒõÓ°."));
                    EditorGUILayout.PropertyField(turbulence1, new GUIContent("µÍÕñ·ùÍÄÁ÷", "µÍÕñ·ùÍÄÁ÷."));
                    EditorGUILayout.PropertyField(turbulence2, new GUIContent("¸ßÕñ·ùÍÄÁ÷", "¸ßÕñ·ùÍÄÁ÷."));
                    EditorGUILayout.PropertyField(frecuency, new GUIContent("ÆµÂÊ", "ÍÄÁ÷µÄÆµ·±ÐÔ¡£Ôö¼ÓÒÔ²úÉú¸ü¶ÌµÄ²¨ÀË."));
                    EditorGUILayout.PropertyField(speed, new GUIContent("ËÙ¶È", "ÍÄÁ÷¶¯»­µÄËÙ¶È."));

                    if (detailed >= 10)
                    {
                        EditorGUILayout.PropertyField(sparklingIntensity, new GUIContent("ÉÁÉÁ·¢¹âµÄÇ¿¶È", "ÉÁ¹âÁ£×ÓµÄÁÁ¶È."));
                        EditorGUILayout.PropertyField(sparklingAmount, new GUIContent("ÆðÅÝÁ¿", "ÉÁÉÁ·¢¹â/ÉÁ¹â¿ÅÁ£µÄÊýÁ¿."));
                    }

                    EditorGUILayout.PropertyField(deepObscurance, new GUIContent("Éî¶ÈÕÚµ²", "Ê¹ÒºÌåµÄµ×²¿±ä°µ."));
                    EditorGUILayout.PropertyField(scatteringEnabled, new GUIContent("¹âÉ¢Éä", "Ê¹±³¹â´©¹ýÒºÌå²úÉú¹âÀ©É¢Ð§¹û."));
                    if (scatteringEnabled.boolValue)
                    {
                        EditorGUILayout.PropertyField(scatteringPower, new GUIContent("   Á¦¶È", "¹âÉ¢Éä·½³ÌµÄ¹¦ÂÊ£¨Ö¸Êý£©."));
                        EditorGUILayout.PropertyField(scatteringAmount, new GUIContent("   Á¿", "¹âÉ¢ÉäÐ§Ó¦µÄ×îÖÕ³Ë·¨Æ÷»òË¥¼õ."));
                    }

                    if (detailed == 0)
                    {
                        EditorGUILayout.PropertyField(foamVisibleFromBottom, new GUIContent("´Óµ×²¿¿É¼û", "Èç¹û´Óµ×²¿¹Û²ìÈÝÆ÷Ê±£¬Í¨¹ýÒºÌå¿ÉÒÔ¿´µ½ÅÝÄ­."));
                    }

                }

                if (detailed >= 10)
                {
                    EditorGUILayout.Separator();
                    expandSection[FOAM_SETTINGS] = EditorGUILayout.Foldout(expandSection[FOAM_SETTINGS], "ÅÝÄ­µÄÉèÖÃ", sectionHeaderStyle);

                    if (expandSection[FOAM_SETTINGS])
                    {
                        EditorGUILayout.PropertyField(foamColor, new GUIContent("ÑÕÉ«"));
                        EditorGUILayout.PropertyField(foamScale, new GUIContent("±ÈÀý", "Ó¦ÓÃÓÚÅÝÄ­ÎÆÀíµÄ¿Ì¶È."));
                        EditorGUILayout.PropertyField(foamThickness, new GUIContent("ºñ¶È"));
                        EditorGUILayout.PropertyField(foamDensity, new GUIContent("ÃÜ¶È"));
                        EditorGUILayout.PropertyField(foamWeight, new GUIContent("ÖØÁ¿", "ÖµÔ½´ó£¬ÅÝÄ­ÓëÒºÌåµÄµ×ÏßÃÜ¶ÈÔ½´ó."));
                        EditorGUILayout.PropertyField(foamTurbulence, new GUIContent("ÍÄÁ÷", "Ó°ÏìÅÝÄ­µÄÒºÌåÍÄÁ÷µÄ³ËÊý¡£½«ÆäÉèÖÃÎªÁãÒÔ²úÉú¾²µçÅÝÄ­."));
                        EditorGUILayout.PropertyField(foamVisibleFromBottom, new GUIContent("´Óµ×²¿¿É¼û", "Èç¹û´Óµ×²¿¹Û²ìÈÝÆ÷Ê±£¬Í¨¹ýÒºÌå¿ÉÒÔ¿´µ½ÅÝÄ­."));
                    }
                }
            }

            EditorGUILayout.Separator();
            expandSection[SMOKE_SETTINGS] = EditorGUILayout.Foldout(expandSection[SMOKE_SETTINGS], "ÑÌÎíµÄÉèÖÃ", sectionHeaderStyle);

            if (expandSection[SMOKE_SETTINGS])
            {
                EditorGUILayout.PropertyField(smokeEnabled, new GUIContent("¿É¼û"));
                if (smokeEnabled.boolValue)
                {
                    EditorGUILayout.PropertyField(smokeColor, new GUIContent("ÑÕÉ«"));
                    if (detailed >= 10)
                    {
                        EditorGUILayout.PropertyField(smokeScale, new GUIContent("±ÈÀý", "Ó¦ÓÃÓÚÓÃÓÚÑÌÎíµÄÎÆÀíµÄ¿Ì¶È."));
                        EditorGUILayout.PropertyField(smokeSpeed, new GUIContent("ËÙ¶È"));
                    }
                    EditorGUILayout.PropertyField(smokeBaseObscurance, new GUIContent("»ù´¡ÕÚµ²", "Ê¹µ×²¿µÄÑÌÎí±ä°µ."));
                }
            }

            if (detailed != (int)DETAIL.DefaultNoFlask && detailed != (int)DETAIL.Smoke)
            {
                EditorGUILayout.Separator();
                expandSection[FLASK_SETTINGS] = EditorGUILayout.Foldout(expandSection[FLASK_SETTINGS], "Æ¿×ÓµÄÉèÖÃ", sectionHeaderStyle);

                if (expandSection[FLASK_SETTINGS])
                {
                    EditorGUILayout.PropertyField(flaskTint, new GUIContent("É«µ÷", "Ó¦ÓÃÓÚ¾§ÌåµÄÉ«µ÷ÑÕÉ«."));
                    EditorGUILayout.PropertyField(flaskThickness, new GUIContent("ºñ¶È", "Ë®¾§Ë¼Î¬."));
                    EditorGUILayout.PropertyField(flaskGlossinessExternal, new GUIContent("¹âÔó¶È ÍâÔÚ", "¾§ÌåÍâ±íÃæµÄ¹âÔó¶È."));
                    if (detailed != 30)
                    {
                        EditorGUILayout.PropertyField(flaskGlossinessInternal, new GUIContent("¹âÔó¶È ÄÚ²¿", "¾§ÌåÄÚ±íÃæµÄ¹âÔó¶È."));
                    }
                    else
                    {
                        EditorGUILayout.PropertyField(reflectionTexture, new GUIContent("·´Éä", "Îª·´ÉäÐ§¹ûÖ¸¶¨Á¢·½ÌåÌùÍ¼ÎÆÀí."));
                        EditorGUILayout.PropertyField(textureAlpha, new GUIContent("Í¸Ã÷¶È"));
                    }
                    if (detailed == 20)
                    {
                        EditorGUILayout.PropertyField(texture, new GUIContent("ÎÆÀí", "ÎªÒºÌåÈÝÆ÷Ö¸¶¨ÎÆÀí."));
                        EditorGUILayout.PropertyField(textureAlpha, new GUIContent("   Í¸Ã÷¶È"));
                        EditorGUILayout.PropertyField(textureScale, new GUIContent("   ±ÈÀý"));
                        EditorGUILayout.PropertyField(textureOffset, new GUIContent("   Æ«ÒÆÁ¿"));
                        EditorGUILayout.PropertyField(bumpMap, new GUIContent("·¨ÏßÌùÍ¼", "ÎªÒºÌåÈÝÆ÷Ö¸¶¨·¨ÏßÌùÍ¼."));
                    }
                    EditorGUILayout.PropertyField(refractionBlur, new GUIContent("·´ÉäÄ£ºý", "Í¨¹ýÆ¿×Ó¿É¼ûµÄÄ£ºý±³¾°."));
                    if (refractionBlur.boolValue)
                    {
                        EditorGUILayout.PropertyField(blurIntensity, new GUIContent("   Ç¿¶È"));
                        EditorGUILayout.PropertyField(distortionMap, new GUIContent("   Ê§ÕæÍ¼", "ÔÚ´Ë²å²ÛÖÐÎª¾§ÌåÊ§ÕæÖ¸¶¨ÖÃ»»Í¼."));
                        EditorGUILayout.PropertyField(distortionAmount, new GUIContent("   Ê§ÕæÁ¿"));
                    }

                    EditorGUILayout.PropertyField(bumpDistortionScale, new GUIContent("°¼Í¹/Ê§Õæ±ÈÀý", "°¼Í¹ºÍÊ§ÕæÌùÍ¼ÎÆÀíµÄÎÆÀí±ÈÀý."));
                    EditorGUILayout.PropertyField(bumpDistortionOffset, new GUIContent("°¼Í¹/Ê§ÕæÆ«ÒÆ", "°¼Í¹ºÍÊ§ÕæÌùÍ¼ÎÆÀíµÄÎÆÀíÆ«ÒÆ."));

                }
            }

            EditorGUILayout.Separator();
            expandSection[PHYSICS_SETTINGS] = EditorGUILayout.Foldout(expandSection[PHYSICS_SETTINGS], "ÎïÀíÉèÖÃ", sectionHeaderStyle);
            if (expandSection[PHYSICS_SETTINGS])
            {
                EditorGUILayout.PropertyField(reactToForces, new GUIContent("¶ÔÁ¦×ö³ö·´Ó¦", "ÆôÓÃºó£¬ÒºÌå½«ÔÚÉÕÆ¿ÄÚÒÆ¶¯£¬ÊÔÍ¼·´ÉäÍâÁ¦."));
                GUI.enabled = reactToForces.boolValue;
                EditorGUILayout.PropertyField(physicsMass, new GUIContent("ÖÊÁ¿", "¸ü´óµÄÖÊÁ¿½«Ê¹ÒºÌå¸ü¼Ó¾²Ì¬."));
                EditorGUILayout.PropertyField(physicsAngularDamp, new GUIContent("½Ç¶È³±Êª", "ÒºÌåÓëÉÕÆ¿µÄÄ¦²ÁÁ¿£¬Ëü¾ö¶¨ÁËÒºÌåÔÚÊ©¼ÓÁ¦ºó·µ»ØÕý³£Î»ÖÃµÄËÙ¶È."));
                GUI.enabled = !reactToForces.boolValue;
                EditorGUILayout.PropertyField(ignoreGravity, new GUIContent("ºöÂÔÖØÁ¦", "ÆôÓÃºó£¬ÒºÌå½«ËæÆ¿×ÓÐý×ª¡£Ä¬ÈÏÇé¿öÏÂÎª false£¬ÕâÒâÎ¶×ÅÒºÌå½«Í£ÁôÔÚÉÕÆ¿µÄµ×²¿."));
                GUI.enabled = true;
            }

            EditorGUILayout.Separator();
            expandSection[ADVANCED_SETTINGS] = EditorGUILayout.Foldout(expandSection[ADVANCED_SETTINGS], "¸ß¼¶ÉèÖÃ", sectionHeaderStyle);

            if (expandSection[ADVANCED_SETTINGS])
            {
                EditorGUILayout.PropertyField(smokeRaySteps, new GUIContent("ÑÌÎíÉäÏß", "ÓÃÓÚ¹¹½¨ÑÌÉ«µÄÃ¿¸öÏñËØµÄÑù±¾Êý."));
                if (detailed != (int)DETAIL.Smoke)
                {
                    EditorGUILayout.PropertyField(liquidRaySteps, new GUIContent("ÒºÌåÉäÏß", "ÓÃÓÚ¹¹½¨ÒºÌåÑÕÉ«µÄÃ¿¸öÏñËØµÄÑù±¾Êý."));
                }
                if (detailed >= 1)
                {
                    if (detailed != (int)DETAIL.Smoke)
                    {
                        EditorGUILayout.PropertyField(foamRaySteps, new GUIContent("ÅÝÄ­ÉäÏß", "ÓÃÓÚ¹¹½¨ÅÝÄ­ÑÕÉ«µÄÃ¿¸öÏñËØµÄÑù±¾Êý."));
                    }
                    EditorGUILayout.PropertyField(noiseVariation, new GUIContent("Ôëµã±ä»¯", "ÔÚ 3 ÖÖ²»Í¬µÄ 3D ÎÆÀíÖ®¼ä½øÐÐÑ¡Ôñ."));
                }
                EditorGUILayout.PropertyField(upperLimit, new GUIContent("ÉÏÏÞ", "ÒºÌå¡¢ÅÝÄ­ºÍÑÌÎíÏà¶ÔÓÚÆ¿×Ó³ß´çµÄÉÏÏÞ."));
                EditorGUILayout.PropertyField(extentsScale, new GUIContent("·¶Î§Ëõ·Å", "¿ÉÑ¡ºÍ¸½¼Ó³ËÊýÓ¦ÓÃÓÚÍø¸ñµÄµ±Ç°´óÐ¡¡£ÓÃÓÚÔÚÐèÒª´Ë¹¦ÄÜµÄÌØ¶¨ÐÍºÅÉÏµ÷ÕûµçÆ½."));
                EditorGUILayout.BeginHorizontal();
                if (GUILayout.Button("ºæ±ºµ±Ç°Transform"))
                {
                    if (EditorUtility.DisplayDialog("ºæ±ºµ±Ç°Transform", "µ±Ç°±ä»»£¨Ðý×ªºÍËõ·Å£©½«×ªÒÆµ½Íø¸ñ±¾Éí¡£ÊÇ·ñÒª¼ÌÐø£¿", "ºÃµÄ", "È¡Ïû"))
                    {
                        foreach (LiquidVolume lv in targets)
                        {
                            BakeRotation(lv);
                        }
                    }
                }
                if (GUILayout.Button("ÖÐÐÄÃªµã"))
                {
                    if (EditorUtility.DisplayDialog("ÖÐÐÄÃªµã", "¶¥µã½«±»ÒÆÎ»£¬Òò´ËÊàÖá½«ÖØÐÂ¶¨Î»ÔÚÆäÖÐÐÄ¡£ÊÇ·ñÒª¼ÌÐø£¿", "ºÃµÄ", "È¡Ïû"))
                    {
                        foreach (LiquidVolume lv in targets)
                        {
                            CenterPivot(lv);
                        }
                    }
                }
                EditorGUILayout.EndHorizontal();
                EditorGUILayout.PropertyField(allowViewFromInside, new GUIContent("ÔÊÐí´ÓÄÚ²¿²é¿´", "µ±Ïà»ú½øÈëÈÝÆ÷Ê±£¬ÒºÌåÊÇ¿É¼ûµÄ¡£ÕâÊÇÒ»ÏîÊµÑéÐÔ¹¦ÄÜ£¬µ±Ïà»úÎ»ÓÚÈÝÆ÷ÄÚÊ±£¬Ä³Ð©Ñ¡Ïî£¨ÈçÍÄÁ÷£©²»¿ÉÓÃ."));
                EditorGUILayout.PropertyField(doubleSidedBias, new GUIContent("Ë«ÃæÆ«ÖÃ", "¿ÉÓë²»¹æÔòÍø¸ñÒ»ÆðÊ¹ÓÃ£¬ÒÔ¸ÄÉÆË«ÃæÍø¸ñµÄäÖÈ¾£¨¼´ÎÞ¸ÇÑÛ¾µ¾ßÓÐÁ½Ãæ£¬²£Á§µÄÍâ±íÃæºÍÄÚ²¿Ãæ£©¡£ÊäÈëÉÙÁ¿£¬¸ÃÁ¿½«±»¼õÈ¥µ½ÄÚ²¿ÃæµÄÉî¶È£¬ÕâÓ¦¸Ã½«ËüÃÇÅÅ³ýÔÚÒºÌåÐ§Ó¦Ö®Íâ."));
                EditorGUILayout.PropertyField(rotationLevelBias, new GUIContent("Ðý×ªË®Æ½Æ«²î", "Ê¹ÓÃ¸ü×¼È·µÄËã·¨À´¼ÆËãÌî³äÃæ»ý¡£Èç¹ûÒºÌåÔÚÄ³Ð©Ðý×ªÏÂËÆºõÏûÊ§ÁË£¬ÇëÔö¼Ó´ËÖµ."));
                EditorGUILayout.PropertyField(debugSpillPoint, new GUIContent("µ÷ÊÔÒç³öµã", "Ðý×ªÆ¿×ÓÊ±£¬Ëü»áÔÚÒºÌåÓ¦¿ªÊ¼Çãµ¹µÄµãÉÏÏÔÊ¾Ò»¸öÐ¡ÇòÌå."));
                EditorGUILayout.PropertyField(fixedSpillPoint, new GUIContent("¹Ì¶¨Òç³öµã", "Ðý×ªÆ¿×ÓÊ±£¬ÒºÌåÁ÷³öÎ»ÖÃ²»»á¸Ä±ä"));
                EditorGUILayout.PropertyField(limitLevel, new GUIContent("×îµÍË®Æ½", "×îµÍË®Æ½,µÍÓÚÕâ¸öË®Æ½½«²»ÔÙ¼õÉÙ."));
                EditorGUILayout.PropertyField(renderQueue, new GUIContent("äÖÈ¾¶ÓÁÐ", "ÒºÌåÌå»ýÔÚ Transparent+1 ¶ÓÁÐ£¨µÈÓÚ 3001£©´¦äÖÈ¾¡£Äú¿ÉÒÔ½«Æä¸ü¸ÄÎª 3000 ÒÔ³ÊÏÖÎªÆÕÍ¨Í¸Ã÷¶ÔÏó£¬»òÕß¸ù¾ÝÐèÒªÊ¹ÓÃÆäËûÖµ."));
            }


            EditorGUILayout.Separator();


            if (serializedObject.ApplyModifiedProperties() || (Event.current.type == EventType.ExecuteCommand &&
                Event.current.commandName == "UndoRedoPerformed"))
            {
                foreach (LiquidVolume lv in targets)
                {
                    lv.UpdateMaterialProperties();
                }
            }
        }

        #region Mesh tools

        public void BakeRotation(LiquidVolume lv)
        {

            if (PrefabUtility.GetPrefabObject(lv.gameObject) != null)
            {
                PrefabUtility.DisconnectPrefabInstance(lv.gameObject);
            }

            MeshFilter mf = lv.GetComponent<MeshFilter>();
            string meshPath = AssetDatabase.GetAssetPath(mf.sharedMesh);

            Mesh mesh = Instantiate<Mesh>(mf.sharedMesh) as Mesh;
            Vector3[] vertices = mesh.vertices;
            Vector3 scale = lv.transform.localScale;
            lv.transform.localScale = Vector3.one;

            for (int k = 0; k < vertices.Length; k++)
            {
                vertices[k] = lv.transform.TransformVector(vertices[k]);
            }
            mesh.vertices = vertices;
            mesh.RecalculateBounds();
            mf.sharedMesh = mesh;

            SaveMeshAsset(mesh, meshPath);

            lv.transform.localRotation = Quaternion.Euler(0, 0, 0);
            lv.transform.localScale = scale;

            RefreshCollider(lv);
        }

        public void CenterPivot(LiquidVolume lv)
        {

            if (PrefabUtility.GetPrefabObject(lv.gameObject) != null)
            {
                PrefabUtility.DisconnectPrefabInstance(lv.gameObject);
            }

            MeshFilter mf = lv.GetComponent<MeshFilter>();
            string meshPath = AssetDatabase.GetAssetPath(mf.sharedMesh);

            Mesh mesh = Instantiate<Mesh>(mf.sharedMesh) as Mesh;
            Vector3[] vertices = mesh.vertices;

            Vector3 midPoint = Vector3.zero;
            for (int k = 0; k < vertices.Length; k++)
            {
                midPoint += vertices[k];
            }
            midPoint /= vertices.Length;
            for (int k = 0; k < vertices.Length; k++)
            {
                vertices[k] -= midPoint;
            }
            mesh.vertices = vertices;
            mesh.RecalculateBounds();
            mf.sharedMesh = mesh;

            SaveMeshAsset(mesh, meshPath);

            lv.transform.localPosition += midPoint;

            RefreshCollider(lv);
        }

        void SaveMeshAsset(Mesh mesh, string originalMeshPath)
        {
            if (originalMeshPath == null)
                return;
            string newPath = Path.ChangeExtension(originalMeshPath, null);
            AssetDatabase.CreateAsset(mesh, newPath + "_edited");
            AssetDatabase.SaveAssets();
            AssetDatabase.Refresh();
        }

        void RefreshCollider(LiquidVolume lv)
        {
            MeshCollider mc = lv.GetComponent<MeshCollider>();
            if (mc != null)
            {
                Mesh oldMesh = mc.sharedMesh;
                mc.sharedMesh = null;
                mc.sharedMesh = oldMesh;
            }
        }

        #endregion


    }

}
